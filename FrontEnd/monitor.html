que<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor en Vivo - Evento</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        body {
            background-color: #0a0e27;
            color: #ffffff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .monitor-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .stat-card {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 3rem;
            font-weight: bold;
            color: #4ade80;
        }

        .stat-label {
            font-size: 1rem;
            color: #a0aec0;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .activity-card {
            background: #1a1f3a;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .activity-table {
            background: #1a1f3a;
            border-radius: 10px;
            overflow: hidden;
        }

        .table-dark {
            --bs-table-bg: #1a1f3a;
            --bs-table-border-color: #2d3548;
        }

        .table-dark tbody tr {
            border-bottom: 1px solid #2d3548;
            transition: background-color 0.3s ease;
        }

        .table-dark tbody tr:hover {
            background-color: #252b47;
        }

        .new-entry {
            animation: highlight 2s ease-in-out;
        }

        @keyframes highlight {
            0% { background-color: #4ade80; }
            100% { background-color: transparent; }
        }

        .badge-acreditado {
            background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
        }

        .badge-nuevo {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
        }

        .refresh-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(74, 222, 128, 0.2);
            border: 2px solid #4ade80;
            padding: 10px 20px;
            border-radius: 30px;
            z-index: 1000;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .section-title {
            color: #667eea;
            font-weight: bold;
            font-size: 1.5rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .time-badge {
            background: rgba(102, 126, 234, 0.2);
            border: 1px solid #667eea;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.85rem;
            color: #a0aec0;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <!-- Header -->
        <div class="monitor-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="mb-0"><i class="bi bi-activity me-2"></i>Monitor en Vivo</h1>
                    <p class="mb-0 mt-2" id="eventName">Cargando evento...</p>
                </div>
                <div class="text-end">
                    <div class="refresh-indicator" id="refreshIndicator">
                        <i class="bi bi-arrow-clockwise me-2"></i>
                        <span id="refreshTimer">Actualizando...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Estadísticas en tiempo real -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-number" id="totalInvitados">0</div>
                    <div class="stat-label">Total Invitados</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-number" id="totalAcreditados">0</div>
                    <div class="stat-label">Acreditados</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-number" id="totalNuevos">0</div>
                    <div class="stat-label">Nuevos Registros</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-number" id="porcentajeAcreditacion">0%</div>
                    <div class="stat-label">% Acreditación</div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Últimas acreditaciones -->
            <div class="col-md-6">
                <div class="section-title">
                    <i class="bi bi-clock-history"></i>
                    Últimas Acreditaciones
                </div>
                <div class="activity-table">
                    <table class="table table-dark table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Hora</th>
                                <th>Nombre</th>
                                <th>Evento</th>
                            </tr>
                        </thead>
                        <tbody id="ultimasAcreditaciones">
                            <tr>
                                <td colspan="3" class="text-center text-muted">
                                    <i class="bi bi-hourglass-split me-2"></i>Esperando acreditaciones...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Nuevos registros -->
            <div class="col-md-6">
                <div class="section-title">
                    <i class="bi bi-person-plus"></i>
                    Nuevos Registros
                </div>
                <div class="activity-table">
                    <table class="table table-dark table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Hora</th>
                                <th>Nombre</th>
                                <th>Evento</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody id="nuevosRegistros">
                            <tr>
                                <td colspan="4" class="text-center text-muted">
                                    <i class="bi bi-hourglass-split me-2"></i>Esperando nuevos registros...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/config.js"></script>
    <script>
        const API_BASE_URL = CONFIG.API.BASE_URL;
        const REFRESH_INTERVAL = 5000; // 5 segundos
        let refreshCounter = 0;
        let previousAcreditados = new Set();
        let previousNuevos = new Set();
        let eventos = {};
        let allGuests = [];

        // Cargar todos los eventos y sus invitados de una sola vez
        async function loadAllData() {
            try {
                // Cargar eventos con estadísticas
                const eventsResponse = await fetch(`${API_BASE_URL}/Event/GetAllWithStats`);
                if (!eventsResponse.ok) {
                    console.error('Error al cargar eventos');
                    return;
                }

                const eventList = await eventsResponse.json();
                console.log('Eventos cargados:', eventList);

                // Guardar nombres de eventos
                eventList.forEach(event => {
                    eventos[event.id] = event.nombre;
                });

                document.getElementById('eventName').textContent = `Monitor General (${eventList.length} eventos)`;

                // Cargar invitados de todos los eventos en paralelo
                const guestPromises = eventList.map(async (event) => {
                    try {
                        const response = await fetch(`${API_BASE_URL}/List/GetAll?eventId=${event.id}`);
                        if (response.ok) {
                            const guests = await response.json();
                            return guests.map(g => ({
                                ...g,
                                eventoNombre: event.nombre
                            }));
                        }
                        return [];
                    } catch (err) {
                        console.error(`Error al cargar invitados del evento ${event.id}:`, err);
                        return [];
                    }
                });

                const guestsArrays = await Promise.all(guestPromises);
                allGuests = guestsArrays.flat();
                console.log('Total invitados cargados:', allGuests.length);

            } catch (error) {
                console.error('Error al cargar datos:', error);
                document.getElementById('eventName').textContent = 'Error al cargar datos';
            }
        }

        // Obtener estadísticas globales
        async function loadStats() {
            try {
                const total = allGuests.length;
                const acreditados = allGuests.filter(g => g.acreditado > 0).length;
                const nuevos = allGuests.filter(g => g.esNuevo).length;

                document.getElementById('totalInvitados').textContent = total;
                document.getElementById('totalAcreditados').textContent = acreditados;
                document.getElementById('totalNuevos').textContent = nuevos;

                const porcentaje = total > 0
                    ? Math.round((acreditados / total) * 100)
                    : 0;
                document.getElementById('porcentajeAcreditacion').textContent = `${porcentaje}%`;
            } catch (error) {
                console.error('Error al cargar estadísticas:', error);
            }
        }

        // Obtener últimas acreditaciones
        async function loadRecentAccreditations() {
            try {
                // Filtrar solo los que tienen HoraAcreditacion Y están acreditados
                const acreditadosConHora = allGuests
                    .filter(a => a.horaAcreditacion && a.acreditado > 0)
                    .sort((a, b) => new Date(b.horaAcreditacion) - new Date(a.horaAcreditacion))
                    .slice(0, 20);

                const tbody = document.getElementById('ultimasAcreditaciones');

                if (acreditadosConHora.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="3" class="text-center text-muted">
                                <i class="bi bi-hourglass-split me-2"></i>Aún no hay acreditaciones
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = acreditadosConHora.map(inv => {
                    const isNew = !previousAcreditados.has(inv.id);
                    if (isNew) previousAcreditados.add(inv.id);

                    const hora = new Date(inv.horaAcreditacion);
                    const horaFormateada = hora.toLocaleTimeString('es-AR', {
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });

                    const eventoNombre = inv.eventoNombre || eventos[inv.eventoId] || 'Sin evento';

                    return `
                        <tr class="${isNew ? 'new-entry' : ''}">
                            <td><span class="time-badge">${horaFormateada}</span></td>
                            <td><strong>${inv.nombre || ''} ${inv.apellido || ''}</strong></td>
                            <td>${eventoNombre}</td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error al mostrar acreditaciones:', error);
            }
        }

        // Obtener nuevos registros
        async function loadNewRegistrations() {
            try {
                // Filtrar solo los nuevos y ordenar por ID descendente
                const nuevosRecientes = allGuests
                    .filter(g => g.esNuevo)
                    .sort((a, b) => b.id - a.id)
                    .slice(0, 20);

                const tbody = document.getElementById('nuevosRegistros');

                if (nuevosRecientes.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="4" class="text-center text-muted">
                                <i class="bi bi-hourglass-split me-2"></i>Aún no hay registros nuevos
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = nuevosRecientes.map(inv => {
                    const isNew = !previousNuevos.has(inv.id);
                    if (isNew) previousNuevos.add(inv.id);

                    const acreditadoBadge = inv.acreditado > 0
                        ? '<span class="badge-acreditado">Acreditado</span>'
                        : '<span class="badge text-bg-secondary">Pendiente</span>';

                    const eventoNombre = inv.eventoNombre || eventos[inv.eventoId] || 'Sin evento';

                    // Mostrar hora de acreditación si existe, sino mostrar guiones
                    let horaFormateada = '-';
                    if (inv.horaAcreditacion) {
                        const hora = new Date(inv.horaAcreditacion);
                        horaFormateada = hora.toLocaleTimeString('es-AR', {
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit'
                        });
                    }

                    return `
                        <tr class="${isNew ? 'new-entry' : ''}">
                            <td><span class="time-badge">${horaFormateada}</span></td>
                            <td><strong>${inv.nombre || ''} ${inv.apellido || ''}</strong></td>
                            <td>${eventoNombre}</td>
                            <td>${acreditadoBadge}</td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error al mostrar nuevos registros:', error);
            }
        }

        // Actualizar solo las vistas (sin recargar datos)
        async function refreshViews() {
            loadStats();
            loadRecentAccreditations();
            loadNewRegistrations();
        }

        // Actualizar todos los datos
        async function refreshData() {
            refreshCounter++;
            document.getElementById('refreshTimer').textContent = `Actualizando... (${refreshCounter})`;

            await loadAllData();
            refreshViews();

            document.getElementById('refreshTimer').textContent = `Actualizado (${refreshCounter})`;
        }

        // Iniciar monitoreo
        function startMonitoring() {
            // Primera carga inmediata
            refreshData();

            // Actualizar cada X segundos
            setInterval(refreshData, REFRESH_INTERVAL);
        }

        // Inicializar cuando la página carga
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Iniciando monitor...');
            startMonitoring();
        });
    </script>
</body>
</html>
